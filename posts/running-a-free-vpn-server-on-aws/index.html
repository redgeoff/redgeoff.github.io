<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.78.1"><title>Running a Free VPN Server on AWS &#183; redgeoff</title><meta name=description content="Run OpenVPN on an AWS EC2 instance"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMV9CF3YF6"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','G-ZMV9CF3YF6');</script><meta itemprop=name content="Running a Free VPN Server on AWS"><meta itemprop=description content="Run OpenVPN on an AWS EC2 instance"><meta itemprop=datePublished content="2017-07-24T07:39:02-08:00"><meta itemprop=dateModified content="2017-07-24T07:39:02-08:00"><meta itemprop=wordCount content="1004"><meta itemprop=image content="https://redgeoff.com/posts/vpn/network-with-vpn.png"><meta itemprop=keywords content="aws,vpn,security,firewall,hacking,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://redgeoff.com/posts/vpn/network-with-vpn.png"><meta name=twitter:title content="Running a Free VPN Server on AWS"><meta name=twitter:description content="Run OpenVPN on an AWS EC2 instance"><meta property="og:title" content="Running a Free VPN Server on AWS"><meta property="og:description" content="Run OpenVPN on an AWS EC2 instance"><meta property="og:type" content="article"><meta property="og:url" content="https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/"><meta property="og:image" content="https://redgeoff.com/posts/vpn/network-with-vpn.png"><meta property="article:published_time" content="2017-07-24T07:39:02-08:00"><meta property="article:modified_time" content="2017-07-24T07:39:02-08:00"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://redgeoff.com/#author","name":"Geoff Cox","image":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/d1488b20cd7d55657e0b69f7d779c942?s=400&d=mp"},"description":" "},{"@type":"WebSite","@id":"https://redgeoff.com/#website","url":"https://redgeoff.com/","name":"redgeoff","description":" ","publisher":{"@id":"https://redgeoff.com/#author"},"inLanguage":"en-us"},{"@type":"WebPage","@id":"https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/#webpage","url":"https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/","name":"Running a Free VPN Server on AWS","isPartOf":{"@id":"https://redgeoff.com/#website"},"about":{"@id":"https://redgeoff.com/#author"},"datePublished":"2017-07-24T07:39:02-08:00","dateModified":"2017-07-24T07:39:02-08:00","description":"Run OpenVPN on an AWS EC2 instance","inLanguage":"en-us","potentialAction":[{"@type":"ReadAction","target":["https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/"]}]},{"@type":"Article","isPartOf":{"@id":"https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/#webpage"},"mainEntityOfPage":{"@id":"https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/#webpage"},"headline":"Running a Free VPN Server on AWS","image":["https://redgeoff.com/posts/vpn/network-with-vpn.png"],"datePublished":"2017-07-24T07:39:02-08:00","dateModified":"2017-07-24T07:39:02-08:00","publisher":{"@id":"https://redgeoff.com/#author"},"keywords":["aws","vpn","security","firewall","hacking"],"articleSection":["DevOps"],"inLanguage":"en-us","author":{"@type":"Person","name":null},"potentialAction":[{"@type":"CommentAction","name":"Comment","target":["https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/#comments"]}]}]}</script><link type=text/css rel=stylesheet href=/css/print.css media=print><link type=text/css rel=stylesheet href=/css/poole.css><link type=text/css rel=stylesheet href=/css/hyde.css><style type=text/css>.sidebar{background-color:#fc2803}.read-more-link a{border-color:#fc2803}.pagination li a{color:#fc2803;border:1px solid #fc2803}.pagination li.active a{background-color:#fc2803}.pagination li a:hover{background-color:#fc2803;opacity:.75}footer a,.content a,.related-posts li a:hover{color:#fc2803}</style><link type=text/css rel=stylesheet href=/css/blog.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin=anonymous><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><div class=author-image><img src="https://www.gravatar.com/avatar/d1488b20cd7d55657e0b69f7d779c942?s=200&d=mp" class="img-circle img-headshot center" alt=Gravatar></div><h1>redgeoff</h1><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://redgeoff.com/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/publications/>Publications</a></li><li><a href=/about/>About</a></li><li><a href=/music/>Music</a></li></ul></nav><section class=social-icons><a href=https://github.com/redgeoff rel=me title=GitHub target=_blank><i class="fab fa-github" aria-hidden=true></i></a><a href=https://www.linkedin.com/in/geoffrey-cox rel=me title=Linkedin target=_blank><i class="fab fa-linkedin" aria-hidden=true></i></a><a href=https://medium.com/@redgeoff rel=me title=Medium target=_blank><i class="fab fa-medium" aria-hidden=true></i></a><a href="https://stackoverflow.com/users/2831606/redgeoff?tab=profile" rel=me title=StackOverflow target=_blank><i class="fab fa-stack-overflow" aria-hidden=true></i></a><a href=https://twitter.com/coxgeoffrey rel=me title=Twitter target=_blank><i class="fab fa-twitter" aria-hidden=true></i></a></section></div></aside><main class="content container"><div class=post><h1 class=title>Running a Free VPN Server on AWS</h1><div class=post-date><time datetime=2017-07-24T07:39:02-0800>Jul 24, 2017</time> &#183; 5 min read</div><div><div style=text-align:center><figure class=image><img src=/posts/vpn/network-with-vpn.png alt="Network with VPN"></figure></div><p>This tutorial will take you through the steps of setting up an EC2 instance that will run the OpenVPN Server. It will then cover how to grant and revoke access through the VPN Server.</p><p>AWS has an awesome firewall built into its core services which can easily be used to make sure that only certain ports are open to the outside world. One extra step that we can take is to run a VPN Server that serves as the gateway to our protected EC2 instances. We can then shutdown direct SSH access to our EC2 instances and also have the freedom to block access to our entire network just by revoking access via our VPN Server. The later is very useful if you need to revoke access for a former employee.</p><h3 id=step-1-create-the-vpn-security-group>Step 1— Create the VPN Security Group</h3><p>Overview: security groups allow your servers to communicate with each other in a private cloud while exposing specific ports to the world. We are going to create a security group to allow VPN access to our VPN Server. We will assume that all your other EC2 instances are members of the default security group and that the default security group does not allow access from the outside world.</p><p>Log in at <a href=https://aws.amazon.com>https://aws.amazon.com</a>, type EC2 in the search box and click on the target to go to the EC2 Dashboard.</p><p>From the EC2 dashboard, click <em>Security Groups</em>:</p><div style=text-align:center><figure class=image><img src=/posts/vpn/security-group.png alt="Security Groups"></figure></div><p>Click Create <em>Security Group</em>:</p><div style=text-align:center><figure class=image><img src=/posts/vpn/create-security-group.png alt="Create Security Group"></figure></div><p>Enter a name and description of vpn and specify inbound rules on ports 22, 443, 943 and 1194. Note: the protocol for port 1194 is UDP.</p><div style=text-align:center><figure class=image><img src=/posts/vpn/ports.png alt=Ports></figure></div><p>Note: if the IP addresses that your team uses are static then you can add yet another layer of security by specifying that IP address range in the Source of your rules. However, you’ll want to leave the Source blank if you want your team to be able to connect from different IPs as they may be working from a hotel, home, cafe, etc…</p><h3 id=step-2--create-the-ec2-instance>Step 2 — Create the EC2 Instance</h3><p>Return to the EC2 Dashboard and then click <em>Launch Instance</em>:</p><div style=text-align:center><figure class=image><img src=/posts/vpn/create-instance.png alt="Create EC2 Instance"></figure></div><p>Select Ubuntu (you can of course select almost any other OS that runs OpenVPN, but this tutorial is tailored for Ubuntu)</p><div style=text-align:center><figure class=image><img src=/posts/vpn/ubuntu.png alt="Ubuntu 16 AMI"></figure></div><p>Select t2.nano and click <em>Review and Launch</em></p><div style=text-align:center><figure class=image><img src=/posts/vpn/t2-nano.png alt=t2.nano></figure></div><p>On the next screen, click <em>Edit security groups</em></p><div style=text-align:center><figure class=image><img src=/posts/vpn/security-groups.png alt="Edit security groups"></figure></div><p>Select the <em>vpn</em> and <em>default security groups</em> and click <em>Review and Launch</em></p><div style=text-align:center><figure class=image><img src=/posts/vpn/review-and-launch.png alt="Review and Launch"></figure></div><p>Click <em>Launch</em>, choose your key pair and then click <em>Launch Instances</em></p><h3 id=step-3--disable-sourcedestination-check>Step 3 — Disable Source/Destination Check</h3><p>From the list of instances, select the VPN instance and then Networking->Change Source/Dest. Check from the drop down menu. Then click Yes, Disable. This is needed as otherwise, your VPN server will not be able to connect to your other EC2 instances.</p><div style=text-align:center><figure class=image><img src=/posts/vpn/disable-check.png alt="Disable Source/Destination Check"></figure></div><h3 id=step-4-create-an-elastic-ip-address>Step 4— Create an Elastic IP Address</h3><p>Overview: when an EC2 instance is stopped and restarted, the Public IP address changes. We want the IP address of our VPN Server to remain static so we’ll use an Elastic IP Address.</p><p>From the E2c Dashboard, select <em>Elastic IPs</em></p><div style=text-align:center><figure class=image><img src=/posts/vpn/elastic-ips.png alt="Elastic IPs"></figure></div><p>Click <em>Allocate new address</em></p><div style=text-align:center><figure class=image><img src=/posts/vpn/allocate-new-address.png alt="Allocate New Address"></figure></div><p>Click <em>Allocate</em> and then <em>Close</em>.</p><p>Make a note of your Elastic IP address as this will be the Public IP Address of your VPN Server.</p><p>Then select the Elastic IP and click <em>Associate address</em> from the drop down menu.</p><div style=text-align:center><figure class=image><img src=/posts/vpn/associate-address.png alt="Associate Address"></figure></div><p>Select the EC2 instance you just created and click <em>Associate</em>.</p><div style=text-align:center><figure class=image><img src=/posts/vpn/associate-private-ip.png alt="Associate Private IP"></figure></div><h3 id=step-5-install-and-configure-the-openvpn-server>Step 5— Install and Configure the OpenVPN Server</h3><p>SSH into your VPN server:</p><pre><code>$ ssh ubuntu@PUBLIC-IP-OF-VPN-SERVER
</code></pre><p>Download our helper scripts and set up a default config:</p><pre><code>$ git clone https://github.com/redgeoff/openvpn-server-vagrant
$ cd openvpn-server-vagrant
$ cp config-default.sh config.sh
</code></pre><p>Edit config.sh and enter in your configuration. Note: PUBLIC_IP should be equal to the Elastic IP Address that you created above.</p><pre><code>$ nano config.sh
</code></pre><p>Switch to root</p><pre><code>$ sudo su -
</code></pre><p>Update Ubuntu and install OpenVPN. Note: you will be prompted twice and when you do, select <code>Keep the local version currently installed</code></p><pre><code>$ /home/ubuntu/openvpn-server-vagrant/ubuntu.sh
$ /home/ubuntu/openvpn-server-vagrant/openvpn.sh
</code></pre><p>At this point, the OpenVPN Server is running.</p><h3 id=step-6--add-the-route>Step 6 — Add the Route</h3><p>Routes must be added to the server so that your team’s clients know which traffic to route to the VPN Server.</p><p>You can determine the proper subnet by returning to your list of EC2 instances, clicking on a target instance and identifying the Private IP.</p><div style=text-align:center><figure class=image><img src=/posts/vpn/identify-private-ip.png alt="Identify Private IP"></figure></div><p>Your network will be the first 2 parts of the Private IP appended with zeros, e.g. 172.31.0.0</p><p>On the VPN Server edit <em>/etc/openvpn/server.conf</em> and add something like the following:</p><pre><code>push &quot;route 172.31.0.0 255.255.0.0&quot;
</code></pre><p>Then restart the VPN Server with:</p><pre><code>$ systemctl restart openvpn@server
</code></pre><h3 id=step-7-grant-access-to-your-vpn>Step 7— Grant Access to Your VPN</h3><p>Note: We assume that you are still SSH’d into the VPN and logged in as root.</p><p>Run the following command and be sure to replace <em>client</em> below with a unique name for your user/client.</p><pre><code>$ /home/ubuntu/openvpn-server-vagrant/add-client.sh client
</code></pre><p>You’ll then find a configuration file at</p><pre><code>~/client-configs/files/client-name.ovpn
</code></pre><p>You will want to provide this file to the individual on your team who will be connecting to your VPN. SCP is handy for downloading this .ovpn file from your VPN Server.</p><p>Your team can use one of various VPN clients such as <a href=https://tunnelblick.net/>Tunnelblick</a> (OS X) and <a href=https://openvpn.net/community-downloads/>OpenVPN</a> (Linux, iOS, Android and Windows). After installing one of these clients they should be able to set up the VPN config just by double clicking on the .ovpn file.</p><p>Note: once connected to the VPN, your users will want to use the Private IPs of your EC2 instances. You’ll probably want to use Route 53 to create subdomain records that route to the Private IPs.</p><h3 id=step-8-revoke-access-to-your-vpn>Step 8— Revoke Access to Your VPN</h3><p>Note: We assume that you are still SSH’d into the VPN and logged in as root.</p><p>Run the following command and be sure to replace <em>client</em> below with a unique name for your user/client.</p><pre><code>$ /home/ubuntu/openvpn-server-vagrant/revoke-full.sh client
</code></pre><h3 id=troubleshooting>Troubleshooting</h3><p>If your VPN client reports a <em>TLS handshake failed</em> error then this is most likely because your VPN security group (Step 1) is incorrect. Make sure that you have the correct ports and protocols specified — a common problem is not specifying UDP for port 1194.</p></div><div><ul class=tags><li><a href=https://redgeoff.com/tags/aws/ class=tag-link>aws</a></li><li><a href=https://redgeoff.com/tags/vpn/ class=tag-link>vpn</a></li><li><a href=https://redgeoff.com/tags/security/ class=tag-link>security</a></li><li><a href=https://redgeoff.com/tags/firewall/ class=tag-link>firewall</a></li><li><a href=https://redgeoff.com/tags/hacking/ class=tag-link>hacking</a></li></ul></div><div class=share-buttons><a class=twitter-share-button href=# title="Share on Twitter" data-url=https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/ data-text="Running a Free VPN Server on AWS"><i class="fab fa-twitter"></i></a><a class=linkedin-share-button href=# title="Share on LinkedIn" data-url=https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/ data-text="Running a Free VPN Server on AWS"><i class="fab fa-linkedin-in"></i></a><a class=facebook-share-button href=# title="Share on Facebook" data-url=https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/ data-text="Running a Free VPN Server on AWS"><i class="fab fa-facebook"></i></a><a class=telegram-share-button href=# title="Share on Telegram" data-url=https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/ data-text="Running a Free VPN Server on AWS"><i class="fab fa-telegram"></i></a><a class=pinterest-share-button href=# title="Share on Pinterest" data-url=https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/ data-text="Running a Free VPN Server on AWS"><i class="fab fa-pinterest"></i></a></div></div></main><footer><div><p>&copy; Geoff Cox 2021</p></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin=anonymous></script><script src=/js/jquery.min.js></script><script src=/js/soho.js></script></body></html>