<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.115.3"><title>Run a Free VPN Server on AWS (2022 Edition) &#183; redgeoff</title><meta name=description content="Run OpenVPN on an AWS EC2 instance"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZMV9CF3YF6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZMV9CF3YF6")</script><meta itemprop=name content="Run a Free VPN Server on AWS (2022 Edition)"><meta itemprop=description content="Run OpenVPN on an AWS EC2 instance"><meta itemprop=datePublished content="2022-11-15T10:48:50-08:00"><meta itemprop=dateModified content="2022-11-15T10:48:50-08:00"><meta itemprop=wordCount content="1212"><meta itemprop=image content="https://redgeoff.com/posts/vpn-2022/vpn-splash.jpg"><meta itemprop=keywords content="aws,vpn,security,firewall,hacking,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://redgeoff.com/posts/vpn-2022/vpn-splash.jpg"><meta name=twitter:title content="Run a Free VPN Server on AWS (2022 Edition)"><meta name=twitter:description content="Run OpenVPN on an AWS EC2 instance"><meta property="og:title" content="Run a Free VPN Server on AWS (2022 Edition)"><meta property="og:description" content="Run OpenVPN on an AWS EC2 instance"><meta property="og:type" content="article"><meta property="og:url" content="https://redgeoff.com/posts/free-vpn-aws-2022/"><meta property="og:image" content="https://redgeoff.com/posts/vpn-2022/vpn-splash.jpg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-15T10:48:50-08:00"><meta property="article:modified_time" content="2022-11-15T10:48:50-08:00"><meta property="og:see_also" content="https://redgeoff.com/posts/running-a-free-vpn-server-on-aws/"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://redgeoff.com/#author","name":"Geoff Cox","image":{"@type":"ImageObject","url":"https://www.gravatar.com/avatar/d1488b20cd7d55657e0b69f7d779c942?s=400&d=mp"},"description":" "},{"@type":"WebSite","@id":"https://redgeoff.com/#website","url":"https://redgeoff.com/","name":"redgeoff","description":" ","publisher":{"@id":"https://redgeoff.com/#author"},"inLanguage":"en-us"},{"@type":"WebPage","@id":"https://redgeoff.com/posts/free-vpn-aws-2022/#webpage","url":"https://redgeoff.com/posts/free-vpn-aws-2022/","name":"Run a Free VPN Server on AWS (2022 Edition)","isPartOf":{"@id":"https://redgeoff.com/#website"},"about":{"@id":"https://redgeoff.com/#author"},"datePublished":"2022-11-15T10:48:50-08:00","dateModified":"2022-11-15T10:48:50-08:00","description":"Run OpenVPN on an AWS EC2 instance","inLanguage":"en-us","potentialAction":[{"@type":"ReadAction","target":["https://redgeoff.com/posts/free-vpn-aws-2022/"]}]},{"@type":"Article","isPartOf":{"@id":"https://redgeoff.com/posts/free-vpn-aws-2022/#webpage"},"mainEntityOfPage":{"@id":"https://redgeoff.com/posts/free-vpn-aws-2022/#webpage"},"headline":"Run a Free VPN Server on AWS (2022 Edition)","image":["https://redgeoff.com/posts/vpn-2022/vpn-splash.jpg"],"datePublished":"2022-11-15T10:48:50-08:00","dateModified":"2022-11-15T10:48:50-08:00","publisher":{"@id":"https://redgeoff.com/#author"},"keywords":["aws","vpn","security","firewall","hacking"],"articleSection":["DevOps"],"inLanguage":"en-us","author":{"@type":"Person","name":null},"potentialAction":[{"@type":"CommentAction","name":"Comment","target":["https://redgeoff.com/posts/free-vpn-aws-2022/#comments"]}]}]}</script><link type=text/css rel=stylesheet href=/css/print.css media=print><link type=text/css rel=stylesheet href=/css/poole.css><link type=text/css rel=stylesheet href=/css/hyde.css><style type=text/css>.sidebar{background-color:#fc2803}.read-more-link a{border-color:#fc2803}.read-more-link a:hover{background-color:#fc2803}.pagination li a{color:#fc2803;border:1px solid #fc2803}.pagination li.active a{background-color:#fc2803}.pagination li a:hover{background-color:#fc2803;opacity:.75}footer a,.content a,.related-posts li a:hover{color:#fc2803}</style><link type=text/css rel=stylesheet href=/css/blog.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin=anonymous><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class=container><div class=sidebar-about><div class=author-image><a href=https://redgeoff.com/><img src="https://www.gravatar.com/avatar/d1488b20cd7d55657e0b69f7d779c942?s=200&d=mp" class="img-circle img-headshot center" alt=Gravatar></a></div><h1>redgeoff</h1><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://redgeoff.com/>Home</a></li><li><a href=/posts/>Posts</a></li><li><a href=/publications/>Publications</a></li><li><a href=/about/>About</a></li><li><a href=/music/>Music</a></li></ul></nav><section class=social-icons><a href=https://github.com/redgeoff rel=me title=GitHub target=_blank><i class="fab fa-github" aria-hidden=true></i></a>
<a href=https://www.linkedin.com/in/geoffrey-cox rel=me title=Linkedin target=_blank><i class="fab fa-linkedin" aria-hidden=true></i></a>
<a href=https://medium.com/@redgeoff rel=me title=Medium target=_blank><i class="fab fa-medium" aria-hidden=true></i></a>
<a href="https://stackoverflow.com/users/2831606/redgeoff?tab=profile" rel=me title=StackOverflow target=_blank><i class="fab fa-stack-overflow" aria-hidden=true></i></a>
<a href=https://twitter.com/coxgeoffrey rel=me title=Twitter target=_blank><i class="fab fa-twitter" aria-hidden=true></i></a></section></div></aside><main class="content container"><div class=post><h1 class=title>Run a Free VPN Server on AWS (2022 Edition)</h1><div class=post-date><time datetime=2022-11-15T10:48:50-0800>Nov 15, 2022</time> <span class=readtime>&#183; 6 min read</span></div><div><p>This tutorial will take you through the steps of setting up an EC2 instance running OpenVPN server. It will then cover how to grant and revoke access to your VPN server.</p><figure><img src=/posts/vpn-2022/vpn-splash.jpg alt="Free VPN on AWS"><figcaption><p>Image credit: <a href=https://unsplash.com/@privecstasy>Privecstasy</a> on <a href=https://unsplash.com>Unsplash</a></p></figcaption></figure><p>AWS has an awesome firewall built into its core services, which can easily be used to make sure that only certain ports are open to the outside world. One extra step that we can take is to run a VPN server that serves as the gateway to our protected AWS resource, e.g. EC2, RDS, etc&mldr; We can then shutdown direct access to our AWS resources just by revoking access via our VPN server. This is very useful if you need to revoke access for a former employee.</p><p>AWS now offers a <a href=https://aws.amazon.com/vpn/>managed VPN Service</a>, but this service costs at least $72 a month and is even more expensive when your VPN serves a lot of traffic. A lot of smaller organizations don&rsquo;t need all the features of the managed service and instead can run their own VPN server for just the cost of an EC2 instance. You can even use the free tier so that you don&rsquo;t have to pay anything for the EC2 instance for the 1st year.</p><h3 id=step-1--create-the-vpn-security-group>Step 1 — Create the VPN Security Group</h3><p>Overview: security groups allow your servers to communicate with each other in a private cloud while exposing specific ports to the world. We are going to create a security group to allow VPN access to our VPN server. We will assume that all your other AWS resources are members of the default security group and that the default security group does not allow access from the outside world.</p><p>Log in at <a href=https://aws.amazon.com>https://aws.amazon.com</a>, type <em>EC2</em> in the search box, and click on the target to go to the EC2 Dashboard.</p><p>From the EC2 dashboard, click <em>Security Groups</em>:</p><figure><img src=/posts/vpn-2022/security-groups.png alt="Security Groups"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Click <em>Create security group</em>:</p><figure><img src=/posts/vpn-2022/create-security-group.png alt="Create Security Group"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Enter a name and description of <em>vpn</em> and specify the following inbound rules on ports <em>22</em>, <em>443</em>, <em>943</em>, and <em>1194</em>. Note: the protocol for port <em>1194</em> is <strong>UDP</strong>.</p><figure><img src=/posts/vpn-2022/inbound-rules.png alt=Ports><figcaption><p>Image credit: Author</p></figcaption></figure><p>Note: if the IP addresses that your team uses are static then you can add yet another layer of security by specifying an IP address range in the <em>Source</em> of your rules. However, you’ll want to leave the <em>Source</em> open to anywhere if you want your team to be able to connect from any IP as they may be working from a hotel, home, cafe, etc…</p><h3 id=step-2--create-the-ec2-instance>Step 2 — Create the EC2 Instance</h3><p>Return to the EC2 Dashboard and then click <em>Launch instances</em>:</p><figure><img src=/posts/vpn-2022/launch-instances.png alt="Launch instances"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Select Ubuntu (you can of course select almost any other OS that runs OpenVPN, but this tutorial is tailored to Ubuntu)</p><figure><img src=/posts/vpn-2022/ubuntu-22.png alt="Ubuntu 22"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Select <em>t2.micro</em>:</p><figure><img src=/posts/vpn-2022/t2-nano.png alt="t2 nano"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Note: you can use a nano instance instead of a micro instance, but nano instances are not eligible for the free tier.</p><p>In the <em>Network settings</em> section, select your default VPC and disable the auto-assign public IP option. Then, select both your default security group and the security group that you created above for the VPN.</p><figure><img src=/posts/vpn-2022/network-settings.png alt="Edit security groups"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Click <em>Launch instance</em></p><h3 id=step-3--disable-sourcedestination-check>Step 3 — Disable Source/Destination Check</h3><p>From the list of instances, select the VPN instance and then <em>Actions -> Networking -> Change source/destination check</em> from the drop down menu.</p><figure><img src=/posts/vpn-2022/instance-source-destination.png alt="Instance source destination check"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Select <em>Stop</em> and click <em>Save</em>. This is needed as otherwise, your VPN server will not be able to connect to your other AWS resources.</p><figure><img src=/posts/vpn-2022/edit-source-destination.png alt="Edit source destination check"><figcaption><p>Image credit: Author</p></figcaption></figure><h3 id=step-4--create-an-elastic-ip-address>Step 4 — Create an Elastic IP Address</h3><p>Overview: when an EC2 instance is stopped and restarted, the Public IP address changes. We want the IP address of our VPN server to remain static so we’ll use an Elastic IP Address.</p><p>From the E2C Dashboard, select <em>Elastic IPs</em>:</p><figure><img src=/posts/vpn-2022/elastic-ips-menu.png alt="Elastic IPs"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Click <em>Allocate Elastic IP address</em>:</p><figure><img src=/posts/vpn-2022/allocate-elastic-ip.png alt="Allocate Elastic IP address"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Make a note of your new Elastic IP address as this will be the Public IP Address of your VPN server. We will refer to this address later as <em>PUBLIC-IP-OF-VPN-SERVER</em>.</p><p>Select the IP address you just created and click <em>Associate Elastic IP address</em>:</p><figure><img src=/posts/vpn-2022/associate-elastic-ip.png alt="Associate Elastic IP address"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Then, select the Elastic IP and click <em>Associate address</em> from the drop down menu.</p><p>Select the EC2 instance you created above and click <em>Associate</em>:</p><figure><img src=/posts/vpn-2022/ec2-elastic-ip.png alt="EC2 Elastic IP"><figcaption><p>Image credit: Author</p></figcaption></figure><h3 id=step-5-install-and-configure-the-openvpn-server>Step 5— Install and Configure the OpenVPN Server</h3><p>SSH into your VPN server:</p><pre tabindex=0><code>$ ssh ubuntu@PUBLIC-IP-OF-VPN-SERVER
</code></pre><p>Download our helper scripts and set up a default config:</p><pre tabindex=0><code>$ git clone https://github.com/redgeoff/openvpn-server-vagrant
$ cd openvpn-server-vagrant
$ cp config-default.sh config.sh
</code></pre><p>Edit config.sh and enter in your configuration. Note: <em>PUBLIC_IP</em> should be equal to the Elastic IP Address that you created above.</p><pre tabindex=0><code>$ nano config.sh
</code></pre><p>Switch to root:</p><pre tabindex=0><code>$ sudo su -
</code></pre><p>You&rsquo;ll now update Ubuntu. Note: you will be prompted several times and when you do, just press the <em>Enter</em> key.</p><pre tabindex=0><code>$ /home/ubuntu/openvpn-server-vagrant/ubuntu.sh
</code></pre><p>Now, install OpenVPN. Note: you will be prompted several times and when you do, just press the <em>Enter</em> key.</p><pre tabindex=0><code>$ /home/ubuntu/openvpn-server-vagrant/openvpn.sh
</code></pre><p>At this point, the OpenVPN server is running.</p><h3 id=step-6--add-the-route>Step 6 — Add the Route</h3><p>Routes must be added to the server so that your team’s clients know which traffic to route to the VPN server.</p><p>You can determine the proper subnet by returning to your list of EC2 instances, clicking on a target instance and identifying the Private IP.</p><figure><img src=/posts/vpn-2022/identify-private-ip.png alt="Identify Private IP"><figcaption><p>Image credit: Author</p></figcaption></figure><p>Your network will be the first 2 parts of the Private IP appended with zeros, e.g. <em>172.31.0.0</em></p><p>On the VPN server edit <em>/etc/openvpn/server/server.conf</em> and add something like the following:</p><pre tabindex=0><code>push &#34;route 172.31.0.0 255.255.0.0&#34;
</code></pre><p>Then, restart the VPN server with:</p><pre tabindex=0><code>$ systemctl restart openvpn-server@server.service
</code></pre><h3 id=step-7--grant-access-to-your-vpn>Step 7 — Grant Access to Your VPN</h3><p>Note: We assume that you are still SSH’d into the VPN and logged in as root.</p><p>Run the following command and be sure to replace <em>client</em> below with a unique name for your user/client.</p><pre tabindex=0><code>$ /home/ubuntu/openvpn-server-vagrant/add-client.sh client
</code></pre><p>You’ll then find a configuration file at</p><pre tabindex=0><code>~/client-configs/files/client-name.ovpn
</code></pre><p>You will want to provide this file to the individual on your team who will be connecting to your VPN. SCP is handy for downloading this .ovpn file from your VPN server.</p><p>Your team can use one of various VPN clients such as <a href=https://tunnelblick.net/>Tunnelblick</a> (OS X) and <a href=https://openvpn.net/community-downloads/>OpenVPN</a> (Linux, iOS, Android and Windows). After installing one of these clients, they should be able to set up the VPN config just by double clicking on the .ovpn file.</p><p>Note: once connected to the VPN, your users will want to use the Private IPs of your AWS resources. You may want to use <em>nslookup</em> to lookup the IP address from the AWS custom domain names provided by AWS. You’ll probably want to use Route 53 to create subdomain records that route to the Private IPs.</p><h3 id=step-8--revoke-access-to-your-vpn>Step 8 — Revoke Access to Your VPN</h3><p>Note: We assume that you are still SSH’d into the VPN and logged in as root.</p><p>Run the following command and be sure to replace <em>client</em> below with a unique name for your user/client.</p><pre tabindex=0><code>$ /home/ubuntu/openvpn-server-vagrant/revoke-full.sh client
</code></pre><h3 id=troubleshooting>Troubleshooting</h3><p>If your VPN client reports a <em>TLS handshake failed</em> error then this is most likely because your VPN security group (Step 1) is incorrect. Make sure that you have the correct ports and protocols specified — a common problem is not specifying UDP for port 1194.</p></div><div><ul class=tags><li><a href=https://redgeoff.com/tags/aws/ class=tag-link>aws</a></li><li><a href=https://redgeoff.com/tags/vpn/ class=tag-link>vpn</a></li><li><a href=https://redgeoff.com/tags/security/ class=tag-link>security</a></li><li><a href=https://redgeoff.com/tags/firewall/ class=tag-link>firewall</a></li><li><a href=https://redgeoff.com/tags/hacking/ class=tag-link>hacking</a></li></ul></div><div class=share-buttons><a class=twitter-share-button href=# title="Share on Twitter" data-url=https://redgeoff.com/posts/free-vpn-aws-2022/ data-text="Run a Free VPN Server on AWS (2022 Edition)"><i class="fab fa-twitter"></i></a>
<a class=linkedin-share-button href=# title="Share on LinkedIn" data-url=https://redgeoff.com/posts/free-vpn-aws-2022/ data-text="Run a Free VPN Server on AWS (2022 Edition)"><i class="fab fa-linkedin-in"></i></a>
<a class=facebook-share-button href=# title="Share on Facebook" data-url=https://redgeoff.com/posts/free-vpn-aws-2022/ data-text="Run a Free VPN Server on AWS (2022 Edition)"><i class="fab fa-facebook"></i></a>
<a class=telegram-share-button href=# title="Share on Telegram" data-url=https://redgeoff.com/posts/free-vpn-aws-2022/ data-text="Run a Free VPN Server on AWS (2022 Edition)"><i class="fab fa-telegram"></i></a>
<a class=pinterest-share-button href=# title="Share on Pinterest" data-url=https://redgeoff.com/posts/free-vpn-aws-2022/ data-text="Run a Free VPN Server on AWS (2022 Edition)"><i class="fab fa-pinterest"></i></a></div></div></main><footer><div><p>&copy; Geoff Cox 2023</p></div></footer><script src=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin=anonymous></script>
<script src=/js/jquery.min.js></script>
<script src=/js/soho.js></script></body></html>